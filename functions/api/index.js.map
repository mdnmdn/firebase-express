{"version":3,"sources":["../../src/api/index.js"],"names":["db","require","admin","database","exports","checkInitSurvey","instance","data","ref","once","console","log","orginalData","set","list","search","active","first","count","effectiveInstance","addr","result","val","lowerSearch","toLowerCase","surveyList","Object","keys","map","id","k","name","description","numberOfQuestions","questions","length","filter","survey","indexOf","undefined","slice"],"mappings":";;;;AAAA,MAAMA,KAAKC,QAAQ,aAAR,EAAuBC,KAAvB,CAA6BC,QAA7B,EAAX;;AAEA;;AAEAC,QAAQC,eAAR;AAAA,iCAA0B,WAAOC,WAAW,SAAlB,EAAgC;AACtD,cAAMC,OAAO,MAAMP,GAAGQ,GAAH,CAAQ,SAAQF,QAAS,UAAzB,EAAoCG,IAApC,CAAyC,OAAzC,CAAnB;AACA,YAAI,CAACF,IAAL,EAAU;AACNG,oBAAQC,GAAR,CAAa,iBAAgBL,QAAS,EAAtC;AACA,kBAAMM,cAAc,MAAMZ,GAAGQ,GAAH,CAAQ,kBAAR,EAA2BC,IAA3B,CAAgC,OAAhC,CAA1B;AACA,kBAAMT,GAAGQ,GAAH,CAAQ,SAAQF,QAAS,EAAzB,EAA4BO,GAA5B,CAAgCD,WAAhC,CAAN;AACH;AACJ,KAPD;;AAAA;AAAA;AAAA;AAAA;;AASAR,QAAQU,IAAR;AAAA,kCAAe,WAAO;AAClBR,gBADkB,EACRS,MADQ,EACAC,MADA,EACQC,QAAQ,CADhB,EACmBC,QAAQ;AAD3B,KAAP,EAEL;AACF,cAAMC,oBAAoBb,YAAY,SAAtC;AACAI,gBAAQC,GAAR,CAAY,MAAZ,EAAoB,EAACL,QAAD,EAAWS,MAAX,EAAmBC,MAAnB,EAA2BG,iBAA3B,EAA8CF,KAA9C,EAAqDC,KAArD,EAApB;AACA,cAAME,OAAQ,SAAQD,iBAAkB,UAAxC;AACA,cAAMX,MAAMR,GAAGQ,GAAH,CAAOY,IAAP,CAAZ;AACA;AACA,cAAMC,SAAS,MAAMb,IAAIC,IAAJ,CAAS,OAAT,CAArB;AACA,cAAMF,OAAOc,OAAOC,GAAP,EAAb;AACA,cAAMC,cAAcR,SAASA,OAAOS,WAAP,EAAT,GAAgC,IAApD;AACA,YAAIC,aAAaC,OAAOC,IAAP,CAAYpB,IAAZ,EACJqB,GADI,CACA,aAAK;;AAEN,mBAAO;AACPC,oBAAItB,KAAKuB,CAAL,EAAQD,EADL;AAEPb,wBAAQT,KAAKuB,CAAL,EAAQd,MAFT;AAGPe,sBAAMxB,KAAKuB,CAAL,EAAQC,IAHP;AAIPC,6BAAazB,KAAKuB,CAAL,EAAQE,WAJd;AAKPC,mCAAmBP,OAAOC,IAAP,CAAYpB,KAAKuB,CAAL,EAAQI,SAApB,EAA+BC;AAL3C,aAAP;AAMF,SATG,EAUJC,MAVI,CAUG;AAAA,mBACH,CAACrB,MAAD;AAEG;AACAsB,mBAAOR,EAAP,IAAad,MAAb,IACC,GAAEsB,OAAOL,WAAY,IAAGK,OAAON,IAAK,EAArC,CAAuCP,WAAvC,GACKc,OADL,CACaf,WADb,KAC6B,CAN7B;AAAA,SAVH,EAkBJa,MAlBI,CAkBG;AAAA,mBACJpB,WAAWuB,SAAX,IACAvB,WAAW,EADX;AAEA;AACAA,sBAAUqB,OAAOrB,MAJb;AAAA,SAlBH;AAuBL;AAvBK,SAwBJwB,KAxBI,CAwBEvB,KAxBF,EAwBSA,QAAQC,KAxBjB,CAAjB;AAyBA,eAAOO,UAAP;AACP,KArCD;;AAAA;AAAA;AAAA;AAAA","file":"index.js","sourcesContent":["const db = require('../firebase').admin.database();\n\n//console.log(db);\n\nexports.checkInitSurvey = async (instance = 'default') => {\n    const data = await db.ref(`/data/${instance}/surveys`).once('value');\n    if (!data){\n        console.log(`creating repo ${instance}`);\n        const orginalData = await db.ref(`/data/__template`).once('value');\n        await db.ref(`/data/${instance}`).set(orginalData)\n    }\n};\n\nexports.list = async ({\n    instance, search, active, first = 0, count = 10\n    }) => {\n        const effectiveInstance = instance || 'default';\n        console.log('list', {instance, search, active, effectiveInstance, first, count})\n        const addr = `/data/${effectiveInstance}/surveys`;\n        const ref = db.ref(addr);\n        //return new Promise(r => ref.once('value', val => f(val)));\n        const result = await ref.once('value');\n        const data = result.val();\n        const lowerSearch = search ? search.toLowerCase() : null;\n        let surveyList = Object.keys(data)\n                    .map(k => {\n                        \n                        return {\n                        id: data[k].id,\n                        active: data[k].active,\n                        name: data[k].name,\n                        description: data[k].description,\n                        numberOfQuestions: Object.keys(data[k].questions).length,\n                    }})\n                    .filter(survey => \n                         !search || \n                        (\n                            // eslint-disable-next-line eqeqeq\n                            survey.id == search ||\n                            `${survey.description}|${survey.name}`.toLowerCase()\n                                .indexOf(lowerSearch) >= 0 \n                        ))\n                    .filter(survey =>\n                        active === undefined || \n                        active === '' ||\n                        // eslint-disable-next-line eqeqeq\n                        active == survey.active)\n                    // pagination\n                    .slice(first, first + count);\n        return surveyList;\n};\n\n\n"]}